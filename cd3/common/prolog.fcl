BEGIN_PROLOG

caloDigiTable: {
   protonTimeMap        : @local::protonTimeMap
   muonTimeMap          : @local::muonTimeMap
   MakeCaloReadoutHits  : @local::MakeCaloReadoutHits
}

caloDigiSeq:  [protonTimeMap, muonTimeMap, MakeCaloReadoutHits ]

// FIXME: Tracking.DigiSim should include time maps in addition to other stuff
digitizationSeq: [ @sequence::caloDigiSeq, @sequence::Tracking.DigiSim ]

//----------------------------------------------------------------
// Calorimeter cluster reconstruction
caloRecoTable: {
   MakeCaloCrystalHits  : @local::MakeCaloCrystalHitsNew
   MakeCaloProtoCluster : @local::MakeCaloProtoCluster
   MakeCaloCluster      : @local::MakeCaloCluster
}

caloRecoSeq: [ MakeCaloCrystalHits, MakeCaloProtoCluster, MakeCaloCluster ]

//----------------------------------------------------------------
// PID inputs
pidInputsTable: {
   TrkExtrapolDem: {
      @table::TrackCaloIntersection
      fitparticle: 11
      fitterModuleLabel: TRFDownstreameMinus // MergePatRecDem
   }
   TrackCaloMatchingDem: {
      @table::TrackCaloMatching
      fitparticle: 11
      fitdirection: 0
      fitterModuleLabel: TRFDownstreameMinus // MergePatRecDem
      trkToCaloExtrapolModuleLabel: TrkExtrapolDem
   }
}

pidInputsSeq: [TrkExtrapolDem, TrackCaloMatchingDem]
pidPathBins: [ 0., 50., 100., 150., 200., 250., 300., 1.e12 ]

// Analysis
signalTrackCuts: {
   trkqual: 0.4

   tdmin: 0.57735027
   tdmax: 1.
   d0min: -80
   d0max: 105
   mdmin: 450.
   mdmax: 680.
   t0min: 700.
   t0max: 1695.
   pmin: 103.85
   pmax: 105.50

   caloCuts: {
      clusterInput: "TrackCaloMatchingDem"
      matchChi2: 100.
      emin: 10. // MeV
      emax: 120. // MeV

      pidCut: 0.
      PIDdt: {
	 signalHypothesis: {inputFile: "ConditionsService/data/v5_7_0/pid_ele_dt.tbl"}
	 backgroundHypothesis: {inputFile: "ConditionsService/data/v5_7_0/pid_muo_dt.tbl"}
      }
      PIDEp: {
	 signalHypothesis: {inputFile: "ConditionsService/data/v5_7_0/pid_ele_ep_vs_path.tbl" pathBinBoundaries: @local::pidPathBins}
	 backgroundHypothesis: {inputFile: "ConditionsService/data/v5_7_0/pid_muo_ep_vs_path.tbl" pathBinBoundaries: @local::pidPathBins}
      }
   }
}

vetoTrackCuts: {
   trkqual: -1e15
   tdmin: -1e15
   tdmax: +1e15
   d0min: -1e15
   d0max: +1e15
   mdmin: -1e15
   mdmax: +1e15
   t0min: -1e15
   t0max: +1e15
   pmin: -1e15
   pmax: +1e15
   caloCutsEnabled: false
}

CutAndCountSettings: {
   // Dowstream e- track input
   signalTrackInput: "TRFDownstreameMinus:DownstreameMinus" // FIXME: instance name should not be used
   signalTrackCuts: @local::signalTrackCuts

   trackVetoes: [
      [ "uemVeto", "TRFUpstreameMinus:UpstreameMinus", @local::vetoTrackCuts ]
   ]

   weight: @nil

   kalDiag: @local::KalDiagReadCD3

}

#================================================================
draTopLevelDefs: {
   source: { module_type: RootInput }

   services: {
      message               : @local::default_message
      TFileService          : { fileName : @nil }
      RandomNumberGenerator : {}

      GeometryService        : { inputFile      : "JobConfig/cd3/geom_baseline.txt" }
      ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"        }
      GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt"   }
      BTrkHelper             : @local::BTrkHelperDefault
      SeedService            : @local::automaticSeeds
   }

   physics : {
      producers: {
	 @table::draEventMixing.producers

	 //------------------------------------------------------------------------------
	 // digitization
	 @table::caloDigiTable
	 // FIXME: Tracking.producers below defines digi in addition to defining reco

	 //------------------------------------------------------------------------------
	 // Track reco - multiple hypotheses
	 @table::Tracking.producers

	 // Calorimeter reco
	 @table::caloRecoTable

	 // PID inputs
	 @table::pidInputsTable

	 //------------------------------------------------------------------------------
      }

      //------------------------------------------------------------------------------
      filters: {
	 @table::draEventMixing.filters

	 cutAndCountFilter: {
	    module_type: CutAndCountFilter
	    @table::CutAndCountSettings
	 }
      }

      //------------------------------------------------------------------------------
      analyzers: {
	 // save normalization info to the histogram file
	 genCountLogger: { module_type: GenEventCountReader }

	 timeMapProton: { module_type: SimParticleTimeMapAnalyzer input: protonTimeMap }
	 timeMapMuon: { module_type: SimParticleTimeMapAnalyzer input: muonTimeMap }

	 cutAndCountAnalyzer: {
	    module_type: CutAndCountAnalyzer
	    @table::CutAndCountSettings
	 }
      }

      //==============================================================================
      draCommonTrigSeq : [
	 @sequence::draEventMixing.CD3Mixers
	 , @sequence::digitizationSeq
	 , @sequence::Tracking.TPRDownstreameMinus
	 , @sequence::Tracking.TPRUpstreameMinus
	 , @sequence::caloRecoSeq
	 , @sequence::pidInputsSeq
      ]

      trigger_paths: @nil

      draCommonEndSeq: [ genCountLogger, timeMapProton, timeMapMuon ]
      draCutAndCountEndSeq : [ cutAndCountAnalyzer ]
      end_paths: @nil
   }
}

dra.filteredOutputDef: {
   filteredOutput: {
      fileName: @nil
      module_type    : RootOutput
      SelectEvents   : { SelectEvents: ["draCutAndCountTrigSeq"] }
   }
}

draTopLevelDefs.physics.draCutAndCountTrigSeq: [ @sequence::draTopLevelDefs.physics.draCommonTrigSeq, cutAndCountFilter ]

#----------------------------------------------------------------

END_PROLOG

